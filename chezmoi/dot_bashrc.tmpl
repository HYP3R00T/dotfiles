{{- $variant := .chezmoi.config.scriptEnv.variant | default "workstation" -}}
{{- $install := (index .data.variants $variant).install | default dict -}}

#!/usr/bin/env bash

# History settings
HISTSIZE=2000
HISTFILE=~/.bash_history
HISTCONTROL=ignoredups:erasedups
HISTIGNORE="&:[ ]*:exit:ls:bg:fg:history"
shopt -s histappend
PROMPT_COMMAND="history -a; history -c; history -r; $PROMPT_COMMAND"

# Completion
if [ -f /etc/bash_completion ]; then
  source /etc/bash_completion
fi

# Keybindings (limited compared to Zsh)
bind '"\e[A": history-search-backward'
bind '"\e[B": history-search-forward'
bind '"\e[1;5C": forward-word'
bind '"\e[1;5D": backward-word'
bind '"\C-?": backward-delete-char'

# Aliases
alias ls='ls --color=auto'
alias py='python3'
alias pya='source ./.venv/bin/activate'

# Paths
export PATH="$HOME/.local/share/mise/shims:$HOME/.local/bin:$PATH"

# mise setup
eval "$(mise activate bash)"

{{ if $install.starship }}
# starship setup
if ! mise which starship &>/dev/null; then
    mise use -g starship@latest
    eval "$(mise activate bash)"
fi
eval "$(starship init bash)"
{{ end }}

{{ if $install.kubectl }}
if ! mise which kubectl &>/dev/null; then
    mise use -g kubectl@latest
    eval "$(mise activate bash)"
fi
source <(kubectl completion bash)
alias k='kubectl'
{{ end }}

{{ if $install.terraform }}
if ! mise which terraform &>/dev/null; then
    mise use -g terraform@latest
    eval "$(mise activate bash)"
fi
alias tf='terraform'
{{ end }}

{{ if $install.zoxide }}
if ! mise which zoxide &>/dev/null; then
    mise use -g zoxide@latest
    eval "$(mise activate bash)"
fi
eval "$(zoxide init bash --cmd cd)"
{{ end }}

{{ if $install.fzf }}
if ! mise which fzf &>/dev/null; then
    mise use -g fzf@latest
    eval "$(mise activate bash)"
fi
source <(fzf --bash)
[ -f ~/.fzf.bash ] && source ~/.fzf.bash
export FZF_DEFAULT_OPTS=" \
--color=fg:15,bg:0,hl:14 \
--color=fg+:15,bg+:0,hl+:12 \
--color=info:10,prompt:9,pointer:13 \
--color=marker:10,spinner:13,header:6 \
--multi"
{{ end }}

{{ if $install.bat }}
if ! mise which bat &>/dev/null; then
    mise use -g bat@latest
    eval "$(mise activate bash)"
    bat cache --build
fi
alias cat="bat"
{{ end }}

{{ if $install.dust }}
if ! mise which dust &>/dev/null; then
    mise use -g dust@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.fastfetch }}
if ! mise which fastfetch &>/dev/null; then
    mise use -g fastfetch@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.dive }}
if ! mise which dive &>/dev/null; then
    mise use -g dive@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.btop }}
if ! mise which btop &>/dev/null; then
    mise use -g btop@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.eza }}
if ! mise which eza &>/dev/null; then
    mise use -g eza@latest
    eval "$(mise activate bash)"
fi
alias ls="eza -al --icons --group-directories-first --git --time-style=relative"
alias tree="eza --tree --icons --git-ignore -a"
{{ end }}

{{ if $install.ytdlp }}
if ! mise which yt-dlp &>/dev/null; then
    mise use -g yt@latest-dlp
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.shfmt }}
if ! mise which shfmt &>/dev/null; then
    mise use -g shfmt@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.shellcheck }}
if ! mise which shellcheck &>/dev/null; then
    mise use -g shellcheck@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.jq }}
if ! mise which jq &>/dev/null; then
    mise use -g jq@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.jqp }}
if ! mise which jqp &>/dev/null; then
    mise use -g jqp@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.podman }}
if ! mise which podman &>/dev/null; then
    mise use -g podman@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.flux2 }}
if ! mise which flux &>/dev/null; then
    mise use -g flux2@latest
    eval "$(mise activate bash)"
fi
source <(flux completion bash)
{{ end }}

{{ if $install.k9s }}
if ! mise which k9s &>/dev/null; then
    mise use -g k9s@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.vault }}
if ! mise which vault &>/dev/null; then
    mise use -g vault@latest
    eval "$(mise activate bash)"
fi
complete -o nospace -C vault vault
{{ end }}

{{ if $install.direnv }}
if ! mise which direnv &>/dev/null; then
    mise use -g direnv@latest
    eval "$(mise activate bash)"
fi
eval "$(direnv hook bash)"
{{ end }}

{{ if $install.ripgrep }}
if ! mise which rg &>/dev/null; then
    mise use -g ripgrep@latest
    eval "$(mise activate bash)"
fi
{{ end }}

{{ if $install.lazydocker }}
if ! mise which lazydocker &>/dev/null; then
    mise use -g lazydocker@latest
    eval "$(mise activate bash)"
fi
alias ld=lazydocker
{{ end }}

{{ if $install.uv }}
if ! mise which uv &>/dev/null; then
    mise use -g uv@latest
    eval "$(mise activate bash)"
fi
eval "$(uv generate-shell-completion bash)"
eval "$(uvx --generate-shell-completion bash)"
{{ end }}

{{ if $install.pnpm }}
if ! mise which pnpm &>/dev/null; then
    mise use -g pnpm@latest
    eval "$(mise activate bash)"
fi
{{ end }}

export COLORTERM=truecolor
